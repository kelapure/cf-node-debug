// Generated by CoffeeScript 1.7.1
(function() {
  var ClientSessions, DebuggerIndexHTML, DebuggerIndexHTMLTemplate, PORT_DEBUG, PORT_PROXY, PORT_TARGET, PORT_V8, PRE_D, PRE_P, PRE_T, ProxyDebug, ProxyTarget, appEnv, auth, bodyParser, cfenv, child_process, clientSessions, crypto, express, fs, handlebars, http, httpProxy, kill, passport, path, q, setIsAuthenticated, startDebugger, startProxy, startTarget, stream, utils, _,
    __hasProp = {}.hasOwnProperty,
    __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
    __slice = [].slice;

  fs = require("fs");

  path = require("path");

  crypto = require("crypto");

  stream = require("stream");

  child_process = require("child_process");

  q = require("q");

  _ = require("underscore");

  http = require("http");

  cfenv = require("cfenv");

  express = require("express");

  passport = require("passport");

  httpProxy = require("http-proxy");

  bodyParser = require("body-parser");

  handlebars = require("handlebars");

  clientSessions = require("client-sessions");

  auth = require("./auth");

  utils = require("./utils");

  DebuggerIndexHTML = path.join(__dirname, "..", "web-debugger", "index.html");

  DebuggerIndexHTML = fs.readFileSync(DebuggerIndexHTML, "utf8");

  DebuggerIndexHTMLTemplate = handlebars.compile(DebuggerIndexHTML);

  appEnv = cfenv.getAppEnv();

  PORT_PROXY = appEnv.port;

  PORT_TARGET = appEnv.port + 1;

  PORT_DEBUG = appEnv.port + 2;

  PORT_V8 = 5858;

  ProxyTarget = new httpProxy.createProxyServer({
    target: {
      host: "localhost",
      port: PORT_TARGET
    }
  });

  ProxyDebug = new httpProxy.createProxyServer({
    target: {
      host: "localhost",
      port: PORT_DEBUG
    }
  });

  PRE_T = "target:";

  PRE_D = "debug: ";

  PRE_P = "proxy:";

  ClientSessions = null;

  exports.run = function(args, opts) {
    var cliAuth, debugr, envAuth, match, notAccessible, password, service, sessionOptions, svcAuth, svrAuth, svrAuthString, target, _ref;
    opts["break"] = !!opts["break"];
    opts.verbose = !!opts.verbose;
    if (opts.debugPrefix == null) {
      opts.debugPrefix = "--debugger";
    }
    match = opts.debugPrefix.match(/\/*(.*)\/*/);
    opts.debugPrefix = "/" + match[1];
    utils.vlog("version: " + utils.VERSION);
    utils.vlog("args:    " + (args.join(' ')));
    utils.vlog("opts:    " + (utils.JL(opts)));
    service = appEnv.getService(/cf-node-debug/);
    cliAuth = opts.auth;
    envAuth = process.env.CF_NODE_DEBUG_AUTH;
    svcAuth = service != null ? (_ref = service.credentials) != null ? _ref.auth : void 0 : void 0;
    svrAuthString = cliAuth || envAuth || svcAuth || "local::";
    svrAuth = auth.parseAuthSpec(svrAuthString);
    notAccessible = "debugger won't be accessible";
    if (svrAuth == null) {
      utils.log("unable to parse auth `" + svrAuthString + "`; " + notAccessible);
    } else if (svrAuth.type !== "local") {
      utils.log("invalid auth type for `" + svrAuthString + "`: `" + svrAuth.type + "`; " + notAccessible);
    } else if (svrAuth.userid === "") {
      utils.log("empty userid for `" + svrAuthString + "`; " + notAccessible);
    } else if (svrAuth.password === "") {
      utils.log("empty password for `" + svrAuthString + "`; " + notAccessible);
    } else {
      auth.setUser({
        userid: svrAuth.userid,
        password: svrAuth.password
      });
    }
    password = svrAuth != null ? svrAuth.password : void 0;
    if (password == null) {
      password = "crap";
    }
    if (password === "") {
      password = "crap";
    }
    sessionOptions = {
      cookieName: "cf-node-debug",
      requestKey: "session",
      secret: password,
      duration: 1000 * 60 * 60 * 24 * 7 * 2,
      cookie: {
        path: "" + opts.debugPrefix + "/",
        ephemeral: false,
        httpOnly: true,
        secure: false
      }
    };
    ClientSessions = clientSessions(sessionOptions);
    target = startTarget(args, opts);
    debugr = startDebugger(opts);
    startProxy(opts);
    return process.on("exit", function(code) {
      utils.log("" + PRE_P + " exiting; code: " + code);
      kill("target", target);
      return kill("debugger", debugr);
    });
  };

  kill = function(label, proc) {
    var e;
    try {
      utils.log("killing " + label);
      return proc.kill();
    } catch (_error) {
      e = _error;
      return utils.log("killing " + label + "; exception: " + e);
    }
  };

  startTarget = function(args, opts) {
    var child, env, options, stdio;
    if (_.isString(args)) {
      args = args.trim().split(/\s+/);
    }
    if (args[0] === "node") {
      args.shift();
    }
    if (opts["break"]) {
      args.unshift("--debug-brk");
    } else {
      args.unshift("--debug");
    }
    env = _.clone(process.env);
    env.PORT = PORT_TARGET;
    env.VCAP_APP_PORT = PORT_TARGET;
    stdio = ["ignore", "pipe", "pipe"];
    options = {
      env: env,
      stdio: stdio
    };
    utils.log("" + PRE_T + " starting `node " + (args.join(' ')) + "`");
    child = child_process.spawn("node", args, options);
    child.stdout.pipe(process.stdout);
    child.stderr.pipe(process.stderr);
    child.on("error", function(err) {
      return utils.log("" + PRE_T + " exception: " + err);
    });
    child.on("exit", function(code) {
      return utils.log("" + PRE_T + " exited with code: " + code);
    });
    return child;
  };

  startDebugger = function(opts) {
    var FilterStream, args, child, filterStream, nodeInspector, options, stdio;
    nodeInspector = require.resolve("node-inspector");
    nodeInspector = path.join(nodeInspector, "..", "..", ".bin", "node-inspector");
    nodeInspector = path.relative(process.cwd(), nodeInspector);
    args = [nodeInspector, "--web-port=" + PORT_DEBUG];
    stdio = ["ignore", "pipe", "pipe"];
    options = {
      stdio: stdio
    };
    utils.log("" + PRE_D + " starting `node " + (args.join(' ')) + "`");
    child = child_process.spawn("node", args, options);
    FilterStream = (function(_super) {
      __extends(FilterStream, _super);

      function FilterStream(options) {
        FilterStream.__super__.constructor.apply(this, arguments);
      }

      FilterStream.prototype._transform = function(chunk, enc, cb) {
        var s;
        s = chunk.toString("utf8");
        s = s.replace(/Visit .* to start debugging\.\n/, "");
        s = new Buffer(s, "utf8");
        this.push(s, enc);
        return cb();
      };

      return FilterStream;

    })(stream.Transform);
    filterStream = new FilterStream();
    child.stdout.pipe(filterStream).pipe(process.stdout);
    child.stderr.pipe(process.stderr);
    child.on("error", function(err) {
      return utils.log("" + PRE_D + " exception: " + err);
    });
    child.on("exit", function(code) {
      return utils.log("" + PRE_D + " exited with code: " + code);
    });
    return child;
  };

  startProxy = function(opts) {
    var bowerPath, debugApp, debugPath, debugPrefix, debugPrefixSlash, proxyApp, proxyServer;
    debugPrefix = opts.debugPrefix;
    debugPrefixSlash = "" + debugPrefix + "/";
    ProxyTarget.on("error", function(err, request, response) {
      var socket;
      utils.log("" + PRE_P + " target exception: " + err);
      socket = request;
      if (response.writeHead != null) {
        response.writeHead(500, {
          "Content-Type": "text/plain"
        });
        return response.end("error processing request; check server console.");
      } else if (socket.close != null) {
        return socket.close();
      }
    });
    ProxyDebug.on("error", function(err, request, response) {
      var socket;
      utils.log("" + PRE_P + " debug exception: " + err);
      socket = request;
      if (response.writeHead != null) {
        response.writeHead(500, {
          "Content-Type": "text/plain"
        });
        return response.end("error processing request; check server console.");
      } else if (socket.close != null) {
        return socket.close();
      }
    });
    bowerPath = path.join(__dirname, "..", "bower");
    debugPath = path.join(__dirname, "..", "web-debugger", "cf-node-debug");
    debugApp = express.Router();
    debugApp.use(ClientSessions);
    debugApp.use(bodyParser());
    debugApp.use(passport.initialize());
    debugApp.use(setIsAuthenticated);
    debugApp.use("/bower", express["static"](bowerPath));
    debugApp.use("/cf-node-debug", express["static"](debugPath));
    debugApp.get("/", function(request, response) {
      var data, indexHTML, message, messageShow;
      if (!request.originalUrl.match(/.*\/$/)) {
        response.redirect(debugPrefixSlash);
        return;
      }
      message = request.session.message;
      if ((message != null) && message.length) {
        messageShow = "";
      } else {
        messageShow = "hidden";
      }
      request.session.message = "";
      data = {
        userid: request.session.userid || "[not logged in]",
        message: message,
        messageShow: messageShow,
        loggedOut: "",
        loggedIn: ""
      };
      if (request.isAuthenticated) {
        data.loggedOut = "hidden";
      } else {
        data.loggedIn = "hidden";
      }
      indexHTML = DebuggerIndexHTMLTemplate(data);
      return response.send(indexHTML);
    });
    debugApp.get("/login", function(request, response, next) {
      return response.redirect(debugPrefixSlash);
    });
    debugApp.post("/login", function(request, response, next) {
      var authr;
      authr = passport.authenticate("local", function(err, user, info) {
        if (err != null) {
          request.session.message = err.message;
          return response.redirect(debugPrefixSlash);
        }
        if (!user) {
          request.session.message = info.message;
          return response.redirect(debugPrefixSlash);
        }
        request.session.userid = user.userid;
        request.session.password = user.password;
        return response.redirect(debugPrefixSlash);
      });
      return authr(request, response, next);
    });
    debugApp.post("/logout", function(request, response) {
      request.session.userid = "";
      request.session.password = "";
      return response.redirect(debugPrefixSlash);
    });
    debugApp.get("/logout", function(request, response, next) {
      return response.redirect(debugPrefixSlash);
    });
    debugApp.use(function(request, response, next) {
      if (request.isAuthenticated) {
        return next();
      }
      return response.redirect(debugPrefixSlash);
    });
    debugApp.use(ProxyDebug.web.bind(ProxyDebug));
    proxyApp = express();
    proxyApp.use(debugPrefix, debugApp);
    proxyApp.use(ProxyTarget.web.bind(ProxyTarget));
    proxyServer = http.createServer(proxyApp);
    proxyServer.on("upgrade", function(request, socket, head) {
      var empty, rest, root, _ref;
      _ref = request.url.split(path.sep), empty = _ref[0], root = _ref[1], rest = 3 <= _ref.length ? __slice.call(_ref, 2) : [];
      if (("/" + root) !== debugPrefix) {
        ProxyTarget.ws(request, socket, head);
        return;
      }
      return ClientSessions(request, {}, function() {
        return setIsAuthenticated(request, {}, function() {
          if (!request.isAuthenticated) {
            return socket.destroy();
          }
          return ProxyDebug.ws(request, socket, head);
        });
      });
    });
    utils.log("" + PRE_P + " starting server at: " + appEnv.url);
    utils.log("" + PRE_P + " access debugger at: " + appEnv.url + debugPrefix + "/inspector.html");
    return proxyServer.listen(PORT_PROXY);
  };

  setIsAuthenticated = function(request, response, next) {
    var password, user, userid, _ref;
    _ref = request.session, userid = _ref.userid, password = _ref.password;
    user = auth.getUser();
    request.isAuthenticated = false;
    if ((userid === user.userid) && (password === user.password)) {
      request.isAuthenticated = true;
    }
    return next();
  };

}).call(this);
