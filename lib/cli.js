// Generated by CoffeeScript 1.7.1
(function() {
  var cfNodeDebug, cli, help, nopt, path, utils, _;

  path = require("path");

  _ = require("underscore");

  nopt = require("nopt");

  cfNodeDebug = require("./cf-node-debug");

  utils = require("./utils");

  cli = exports;

  cli.main = function(args) {
    var debugPrefix, defValue, defValues, longOpts, name, opt, opts, parsed, shortName, shortOpts, type, _ref;
    if (args.length === 0) {
      help();
    }
    if ((_ref = args[0]) === "?" || _ref === "-?" || _ref === "--?") {
      help();
    }
    opts = {
      auth: ["a", String],
      "break": ["b", Boolean],
      "debug-prefix": ["d", String, "--debugger"],
      verbose: ["v", Boolean],
      help: ["h", Boolean]
    };
    longOpts = {};
    shortOpts = {};
    defValues = {};
    for (name in opts) {
      opt = opts[name];
      shortName = opt[0], type = opt[1], defValue = opt[2];
      if (type === Boolean) {
        defValue = false;
      }
      shortOpts[shortName] = "--" + name;
      longOpts[name] = type;
      if (defValue != null) {
        defValues[name] = defValue;
      }
    }
    parsed = nopt(longOpts, shortOpts, args, 0);
    if (parsed.help) {
      help();
    }
    args = parsed.argv.remain;
    opts = _.pick(parsed, _.keys(longOpts));
    opts = _.defaults(opts, defValues);
    if (args.length === 0) {
      help();
    }
    utils.verbose(opts.verbose);
    debugPrefix = opts["debug-prefix"].trim();
    if (debugPrefix === "") {
      utils.logError("the value of the --debug-prefix option must be a non-empty string");
    }
    if (debugPrefix.match(/\/+/)) {
      utils.logError("the value of the --debug-prefix option must not a slash");
    }
    return cfNodeDebug.run(args, opts);
  };

  help = function() {
    console.log("usage:\n\n    cf-node-debug [options] -- program arg arg ...\n\n`program arg arg ...` is what you would pass to `node` to start your program.\n\noptions:\n\n    -a --auth           authentication (see below)\n    -d --debug-prefix   URL prefix of requests sent to the debugger\n    -b --break          have the debugger pause at the beginning of the program\n    -v --verbose        generate diagnostic messages\n\nThe default debug-prefix is `--debugger`.\n\nNote that the `--` token is **REQUIRED** if your program or any arguments\nstart with `-`.  Otherwise it's optional.\n\nThis program does the following:\n\n- starts the specified node application with arguments\n  - it's PORT environment variable will be changed to port PORT+1\n  - it will be launched with the appropriate node debug option\n\n- starts node-inspector on PORT+2\n\n- starts a proxy server on the PORT environment variable\n\n- sends non-debug traffic (ie, not prefixed by `--debug-prefix` option) to\n  the specified application\n\n- sends debug traffic (ie, prefixed by `--debug-prefix` option) to\n  node-inspector\n\nexample:\n\n    cf-node-debug -- server.js\n\nauthentication:\n\nWhen you use cf-node-debug, you need to specify authentication parameters\nto access the debugger.  This is to keep random internet people from accessing\nyour application's innards via the debugger.\n\nYou can specify the authentication parameters via the `-a` / `--auth` option,\nor via the `CF_NODE_DEBUG_AUTH` environment variable, or via a Cloud Foundry\nservice.  In all cases, the authentication parameters are specified as\na string of the form:\n\n    scheme:parms\n\nCurrently the only scheme supported is `local`, and the parms for this\nscheme are the userid and password separated by a `:`.  Thus, the\nauthentication parameter of\n\n    local:joeuser:dumbsecret\n\nindicates you should log in with the userid `joeuser` and password `dumbsecret`\nwhen prompted.\n  \nversion: " + utils.VERSION + "; for more info: " + utils.HOMEPAGE);
    return process.exit(1);
  };

  if (require.main === module) {
    cli.main.call(null, process.argv.slice(2));
  }

}).call(this);
